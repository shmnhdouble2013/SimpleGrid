/* build 2013-10-25 17:36:39 */
KISSY.add("gallery/tmSimpleGrid/1.0/index",function(S,XTemplate,Store,Pagination,TL){var DOM=S.DOM,Node=S.Node,Ajax=S.IO,UA=S.UA,Event=S.Event,S_Date=S.Date,win=window,doc=document;var CONTAINERCLS="j_tableContent",CHECKRDIOTH="j_checkRdio",DATA_ELEMENT="row-element",CLS_GRID_ROW_SELECTED="grid-row-selected",ATTR_COLUMN_FIELD="data-column-field",CHECKBOX_TD_INDEX="checkbox-index",CLS_GRID_ROW="grid-row",CLS_GRID_TH="grid-th",CLS_GRID_CELL="grid-cell",COMMAND_BTN="command-btn",CHECKBOXW="60px",CHECKBOXS="30px",DRECTION_TAGS="drection-tags",DRECTION_ASC="asc",DRECTION_DSC="desc",CLS_ROW_ODD="odd-tr",CLS_ROW_EVEN="even-tr",CLS_CHECKBOX="grid-checkbox",CLS_GRID_ROW_OVER="grid-row-over",SELECTALLCLS="j_select_all",THEADCLS=".j_thead",TBODYCLS=".j_tbody",TFOOTCLS=".j_tfoot",CLS_HIDDEN=".cls-hide",GRIDTPL='<div class="table-container j_tableContent">'+"<div>"+'<table class="ui-table">'+'<thead class="j_thead">'+"</thead>"+"</table>"+"</div>"+'<div class="tbody-container">'+'<table class="ui-table">'+'<tbody class="j_tbody"></tbody>'+"</table>"+"</div>"+'<div class="j_tfoot page-container"></div>'+"</div>",LOADMASKTPL='<div class="loading-mask"></div>';var POLLGRIDDEFAULT={columns:[],ajaxUrl:null,isJsonp:false,staticData:[],checkable:false,isShowCheckboxText:false,isPagination:true,pageSize:10,dataField:"id",isOuterTpl:false};function TmSimpleGrid(container,config){var _self=this,config=S.merge(POLLGRIDDEFAULT,config);if(!container){throw"please assign the id of rendered Dom, of the container of this grid!";return}_self.container=S.get(container)?S.get(container):S.get("#"+container);if(!(_self instanceof TmSimpleGrid)){return new TmSimpleGrid(container,config)}TmSimpleGrid.superclass.constructor.call(_self,config);_self.events=["beginappend","afterappend","beginshow","aftershow","rowremoved","rowcreated","afterPageChanged","rowclick","cellclick","rowdblclick","celldblclick","rowselected","rowunselected","rowselectchanged","allRowsSelected","unAllRowsSelected"];_self._init()}S.extend(TmSimpleGrid,S.Base);TmSimpleGrid.VERSION=1;S.augment(TmSimpleGrid,{_init:function(){var _self=this;_self._augmsConfig();_self._initStore();_self._initGrid();_self._eventRender()},_augmsConfig:function(){var _self=this},_eventRender:function(){var _self=this,hedEv=S.query("."+CLS_GRID_TH,_self.thead);Event.delegate(hedEv,"click",function(ev){_self.sortableFn(ev);_self._allSlectEvt(ev)});S.one(_self.tbody).on("click",function(event){_self._rowClickEvent(event.target)}).on("mouseover",function(event){_self._rowOverEvent(event.target)}).on("mouseout",function(event){_self._rowOutEvent(event.target)});_self.pagination&&_self.pagination.on("afterPageChange",function(e){_self._pageChange(e);_self._setHeaderChecked(false);_self.fire("afterPageChanged",_self.store.pageInfo)});_self.on("rowselected rowunselected",function(ev){_self.autoSelect(ev)});Event.delegate(_self.table,"click","a",function(){this.blur()});Event.delegate(_self.table,"click","input",function(){this.blur()})},_initTableDom:function(data){var _self=this,thRow="",table=DOM.create(GRIDTPL);_self.table=table;_self.tbody=S.get(TBODYCLS,table);_self.thead=S.get(THEADCLS,table);_self.tfoot=S.get(TFOOTCLS,table);_self.columns=S.isArray(_self.get("columns"))?_self.get("columns"):[];thRow=DOM.create(_self._getThRowTemplate(data,0));DOM.append(thRow,_self.thead);_self.sortAui=S.query("."+DRECTION_TAGS,_self.thead);if(_self.get("isPagination")){_self.addPagePation(_self.table)}_self.loadingMaster(_self.table);DOM.append(_self.table,_self.container)},_alignTableHead:function(){var _self=this},_pageChange:function(e){var _self=this,curPage=e.idx,storeCurrentPage=_self.store.pageInfo.currentPage;if(storeCurrentPage===curPage){return}if(_self.get("ajaxUrl")){_self.store.load({currentPage:curPage})}else{_self.store.setCurrentPage(curPage);var results=_self.store._localPagination();_self.showData(results)}},_getRowTemplate:function(obj,index){var _self=this;var oddCls=index%2===0?CLS_ROW_ODD:CLS_ROW_EVEN,cellTempArray=[],rowTemplate=null,cellTemp=null,emptyTd="";if(_self.get("checkable")){cellTemp=_self._getCheckedCellTemplate(CLS_GRID_CELL,CLS_CHECKBOX,index);cellTempArray.push(cellTemp)}S.each(_self.columns,function(column,colindex){var value=_self._getFieldValue(obj,column.dataIndex),text=_self._getRenderText(column,value,obj),temp=_self._getCellTemplate(colindex,column,text);cellTempArray.push(temp)});rowTemplate=['<tr rowIndex="',index,'" class="',CLS_GRID_ROW," ",oddCls,'">',cellTempArray.join(""),emptyTd,"</tr>"].join("");return rowTemplate},_getCellTemplate:function(index,column,text){var _self=this,width=_self.setPxCheck(column.width),dataIndex=column.dataIndex,hideText=column.hide?CLS_HIDDEN:"",template=['<td width="'+width+'" class="',CLS_GRID_CELL,hideText,'" colindex="',index,'" data-field="',dataIndex,'">',text,"</td>"].join("");return template},_getCheckedCellTemplate:function(clscell,clsCheck,index){var _self=this,currentPage=_self.store.getCurrentPage(),pageSize=_self.store.getPageSize(),emptyTd=" ",defWidth,aindex="";if(_self.get("isShowCheckboxText")){defWidth=CHECKBOXW;index=++index;aindex=currentPage===1?index:pageSize*(currentPage-1)+index}else{defWidth=CHECKBOXS}return'<td width="'+defWidth+'" class="'+clscell+emptyTd+CHECKBOX_TD_INDEX+'"><input type="checkbox" value="" name="checkboxs" class="'+clsCheck+'">'+aindex+"</td>"},_getThRowTemplate:function(obj,index){var _self=this;if(index>1){return}var cellTempArray=[],rowTemplate=null,cellTemp=null,thTpl="",emptyTd=" ",defWidth=_self.get("isShowCheckboxText")?CHECKBOXW:CHECKBOXS,selectAllText=_self.get("isShowCheckboxText")?"\u5168\u9009":"";if(_self.get("checkable")){thTpl='<th width="'+defWidth+'" class="'+CLS_GRID_TH+emptyTd+'"><input type="checkbox" value="" name="checkboxs" class="'+SELECTALLCLS+'" data-field="">'+selectAllText+"</th>";cellTempArray.push(thTpl)}S.each(_self.columns,function(column,index){var value=_self._getFieldValue(column,column.dataIndex),text=_self._getRenderText(column,value,obj),temp=_self._getThTemplate(column,text,value);cellTempArray.push(temp)});rowTemplate=['<tr rowIndex="',index,'" class="',CLS_GRID_ROW,'">',cellTempArray.join(""),emptyTd,"</tr>"].join("");return rowTemplate},_getThTemplate:function(obj,text,value){var _self=this;var hideCls=obj.hide?CLS_HIDDEN:"",width=_self.setPxCheck(obj.width),title=obj.title,isSortCols=obj.sortable,dataIndex=obj.dataIndex,text=title||text,emptyTd=" ",thTpl="",thAry=[];var dataType=obj.dataType||S.TL.strToDataType(value)||"string";if(isSortCols){thTpl='<th width="'+width+'" class="'+CLS_GRID_TH+emptyTd+hideCls+'"><a href="javascript:void(0)" title="\u70b9\u51fb\u6392\u5e8f" data-field="'+dataIndex+'" data-dataType="'+dataType+'">'+text+'<i class="'+DRECTION_TAGS+'">&nbsp;</i></a></th>';thAry.push(thTpl)}else{thTpl='<th width="'+width+'" class="'+CLS_GRID_TH+emptyTd+hideCls+'" data-field="'+dataIndex+'">'+text+"</th>";thAry.push(thTpl)}return thAry.join("")},autoSelect:function(ev){var _self=this,type=ev.type;if(type==="rowselected"){_self._isAllRowsSelected()&&_self._setHeaderChecked(true)}else{_self._setHeaderChecked(false)}},sortableFn:function(ev){var _self=this,direction="",itagIndex=DOM.first(ev,"i"),field=DOM.attr(ev,"data-field"),cssCls=DOM.attr(itagIndex,"class"),dataType=DOM.attr(ev,"data-dataType"),isSort=DOM.hasClass(itagIndex,DRECTION_TAGS);if(!isSort){return}if(cssCls===DRECTION_TAGS){direction=_self.store.sortInfo.direction.toLowerCase()===DRECTION_ASC?DRECTION_DSC:DRECTION_ASC}else{direction=DOM.hasClass(itagIndex,DRECTION_ASC)?DRECTION_DSC:DRECTION_ASC}_self.store.sort(field,direction.toLocaleUpperCase(),dataType);S.each(_self.sortAui,function(tag){DOM.removeClass(tag,DRECTION_ASC);DOM.removeClass(tag,DRECTION_DSC)});DOM.addClass(itagIndex,direction)},_getFieldValue:function(obj,dataIndex){var _self=this;if(!dataIndex){return""}var arr=dataIndex.split("."),curObj=obj,result;if(arr.length<2){result=curObj[dataIndex]}else{S.each(arr,function(name){if(curObj){result=curObj[name];curObj=result}else{return false}})}return result},_getRenderText:function(column,value,obj){var _self=this,text=value,fn=column.renderer,domRender=S.isFunction(fn)?fn:null;if(domRender){try{text=domRender(value,obj)}catch(ex){S.error("renderer error, occurred in column: "+column.title)}}return text},_initGrid:function(){var _self=this,width=_self.get("width"),height=_self.get("height");_self._initTableDom();if(_self.get("ajaxUrl")){_self.store.load()}else if(_self.get("staticData")){_self.store.setResult(_self.get("staticData"))}else{throw"Grid Data Source Error!"}if(width){_self.setWidth(width)}if(height){_self.setHeight(height)}},_initStore:function(data){var _self=this,dataType=_self.get("isJsonp")?"jsonp":"json";_self.store=new Store({url:_self.get("ajaxUrl"),dataType:dataType,limit:_self.get("pageSize"),localSort:_self.get("isLocalSort"),isPagination:_self.get("isPagination")});if(!_self.store){return}_self.store.on("beforeload",function(){if(_self.loadMask){_self.loadMask.show()}});_self.store.on("load",function(obj){var data=obj.data,curPage=this.getTotalPage(),results=this.getResult();_self.showData(results);if(_self.pagination){_self.pagination.setTotalPage(curPage)}if(_self.loadMask){_self.loadMask.hide()}});_self.store.on("addrecords",function(event){var data=event.data;_self.appendData(data)});_self.store.on("removerecords",function(event){var data=event.data;_self.removeData(data)});_self.store.on("exception",function(){if(_self.loadMask){_self.loadMask.hide()}});_self.store.on("localsort",function(){var results=this.getResult();_self.showData(results)})},setWidth:function(width){var _self=this,outerWidth=DOM.width(_self.container),width=parseInt(_self.setPxCheck(width));if(width){DOM.css(_self.table,"width",width+"px")}},setHeight:function(height){var _self=this,tbodyContainer=S.get(".tbody-container",_self.container),theadHeight=DOM.height(_self.thead),tfootHeight=DOM.height(_self.tfoot),height=parseInt(_self.setPxCheck(height)),height=height-theadHeight-tfootHeight;if(height>0){DOM.css(tbodyContainer,"height",height+"px")}_self.tbodyContainer=tbodyContainer},setPxCheck:function(px){var _self=this,endVaue="auto";if(!px){return}if(S.trim(px)===endVaue){return endVaue}if(S.isNumber(px)){endVaue=px+"px"}else if(S.isString(px)){var isPercentage=px.split("%"),hasPx=px.split("px");if(isPercentage.length>1){console.log("The percentage of CSS values is not supported!");return}if(hasPx.length>1){endVaue=px}}else{console.log("Invalid height or width value!")}return endVaue},addPagePation:function(container){var _self=this;if(!container){return}var pagContainer=S.get(".page-container",container);_self.pagination=new Pagination({container:pagContainer});Event.delegate(pagContainer,"submit","form",function(e){e.preventDefault()})},_enforcePageTal:function(totalPage){var _self=this,totalPage=_self.store.getTotalPage(),totalPage=S.isNumber(totalPage)?totalPage:parseInt(totalPage,10);if(totalPage<1){totalPage=1}if(totalPage>totalPage){totalPage=totalPage}if(totalPage!==totalPage&&_self.pagination){_self.pagination.setTotalPage(totalPage);_self.store.setTotalPage(totalPage)}},loadingMaster:function(tableContainer){var _self=this,mastNode=DOM.create(_self.get("maskTpl")||LOADMASKTPL);if(mastNode){DOM.prepend(mastNode,tableContainer);_self.loadMask=S.one(mastNode)}},_allSlectEvt:function(target){var _self=this,hasAllSelect=DOM.hasClass(target,SELECTALLCLS);if(hasAllSelect){_self._setAllRowsSelected(target.checked)}},_findRow:function(element){return this._lookupByClass(element,CLS_GRID_ROW)},_findCell:function(element){return this._lookupByClass(element,CLS_GRID_CELL)},_lookupByClass:function(element,css){if(DOM.hasClass(element,css)){return element}return DOM.parent(element,"."+css)},_isRowSelected:function(row){return S.one(row).hasClass(CLS_GRID_ROW_SELECTED)},_rowClickEvent:function(target){var _self=this,isBtn=DOM.hasClass(target,COMMAND_BTN),row=_self._findRow(target),cell=_self._findCell(target),rowCheckable=_self.get("checkable"),data=null,eventResult=null;if(row){data=DOM.data(row,DATA_ELEMENT);if(cell){eventResult=_self.fire("cellClick",{data:data,row:row,cell:cell,field:DOM.attr(cell,ATTR_COLUMN_FIELD),domTarget:target});if(eventResult===false){return}}_self.fire("rowclick",{data:data,row:row});if(isBtn){return}if(rowCheckable){if(!_self._isRowSelected(row)){_self._setRowSelected(row,true)}else{_self._setRowSelected(row,false)}}}},_rowDoubleClickEvent:function(target){var _self=this,row=_self._findRow(target),cell=_self._findCell(target),data=null;if(row){data=DOM.data(row,DATA_ELEMENT);if(cell){_self.fire("celldblclick",{data:data,row:row,cell:cell,field:DOM.attr(cell,ATTR_COLUMN_FIELD),domTarget:target})}_self.fire("rowdblclick",{data:data,row:row})}},_rowOverEvent:function(target){var _self=this,row=_self._findRow(target);if(row){S.one(row).addClass(CLS_GRID_ROW_OVER)}},_rowOutEvent:function(target){var _self=this,row=_self._findRow(target);if(row){S.one(row).removeClass(CLS_GRID_ROW_OVER)}},showData:function(data){var _self=this,trs=[];_self.fire("beginshow");_self.clearData();S.each(data,function(obj,index){trs.push(_self._createRow(obj,index))});DOM.html(_self.tbody,trs.join(""));_self.fire("aftershow")},clearData:function(){var _self=this,rows=_self.tbody.rows;S.each(rows,function(row){_self.fire("rowremoved",{data:DOM.data(row,DATA_ELEMENT),row:row})});S.all(rows).remove()},_createRow:function(element,index){var _self=this,rowTemplate="";if(_self.get("isOuterTpl")){rowTemplate=_self.trRender(element,_self.get("trTpl"))}else{rowTemplate=_self._getRowTemplate(element,index)}var rowEl=new Node(rowTemplate),dom=rowEl.getDOMNode();DOM.data(dom,DATA_ELEMENT,element);_self.fire("rowcreated",{data:element,row:dom});return rowTemplate},removeData:function(data){var _self=this,rows=S.makeArray(_self.tbody.rows);S.each(rows,function(row){var obj=DOM.data(row,DATA_ELEMENT);if(obj&&S.inArray(obj,data)){_self.fire("rowremoved",{data:obj,row:row});DOM.remove(row)}})},appendData:function(data){var _self=this,rows=[];_self.fire("beginappend",{data:data});S.each(data,function(obj,index){var row=_self._createRow(obj,index);rows.push(row)});_self.fire("afterappend",{rows:rows,data:data})},tplRender:function(data,tpl){var _self=this,htmlText,creatNode;if(!tpl){throw"Template is undefined!"}try{htmlText=new XTemplate(tpl).render(data);creatNode=DOM.create(htmlText)}catch(e){throw e}return creatNode},clearSelection:function(){var _self=this;_self._setAllRowsSelected(false);_self._setHeaderChecked(false)},_setHeaderChecked:function(checked){var _self=this,checkEl=S.one("."+SELECTALLCLS,_self.thead);if(checkEl){checkEl.attr("checked",checked)}},_setAllRowsSelected:function(selected){var _self=this;S.each(_self.tbody.rows,function(row){_self._setRowSelected(row,selected)});if(selected){_self.fire("allRowsSelected")}else{_self.fire("unAllRowsSelected")}},_setDataSelect:function(data,isSelected){var _self=this;if(!data||isSelected==undefined){console.log("\u5fc5\u987b\u4f20\u5165\u76f8\u5e94\u6570\u636e\u6216\u9009\u4e2d\u72b6\u6001");return}data=S.isArray(data)?data:[data];S.each(data,function(obj){transition(obj,isSelected)});function transition(obj,isSelected){S.each(_self.tbody.rows,function(row){_self._setLockRecords(row,obj,isSelected)})}},_setLockRecords:function(row,compareData,selected){var _self=this,data=DOM.data(row,DATA_ELEMENT),isFind=_self.store.matchFunction(data,compareData);if(isFind){_self.setSelectLock(row,selected)}},_isLocalRows:function(rows,isDisabled){var _self=this;rows=S.isArray(rows)?rows:[rows];S.each(rows,function(row){var checkbox=DOM.get("."+CLS_CHECKBOX,row),data=DOM.data(row,DATA_ELEMENT);if(checkbox){DOM.attr(checkbox,"disabled",isDisabled)}})},setSelectLock:function(row,selected){var _self=this,checkbox=DOM.get("."+CLS_CHECKBOX,row),isDisabled=DOM.attr(checkbox,"disabled");if(isDisabled){DOM.attr(checkbox,"disabled",false)}_self._setRowSelected(row,selected);_self._isLocalRows(row,selected)},_isAllRowsSelected:function(){var _self=this,rows=_self.tbody.rows,val=true;if(rows.length<1){return}else{S.each(rows,function(row){if(!_self._isRowSelected(row)){val=false}});return val}},getSelection:function(){var _self=this,selectedRows=S.all("."+CLS_GRID_ROW_SELECTED,_self.tbody),objs=[];S.each(selectedRows,function(row){var obj=DOM.data(row,DATA_ELEMENT);if(obj){objs.push(obj)}});return objs},_setRowSelected:function(row,selected){var _self=this,checkbox=DOM.get("."+CLS_CHECKBOX,row),data=DOM.data(row,DATA_ELEMENT),hasSelected=DOM.hasClass(row,CLS_GRID_ROW_SELECTED);if(hasSelected===selected){return}if(checkbox){if(DOM.attr(checkbox,"disabled")){return}checkbox.checked=selected}if(selected){DOM.addClass(row,CLS_GRID_ROW_SELECTED);_self._onRowSelectChanged(row,selected)}else{DOM.removeClass(row,CLS_GRID_ROW_SELECTED);_self._onRowSelectChanged(row,selected)}},_onRowSelectChanged:function(row,selected){var _self=this,data=DOM.data(row,DATA_ELEMENT);if(selected){_self.fire("rowselected",{data:data,row:row,type:"rowselected"})}else{_self.fire("rowunselected",{data:data,row:row,type:"rowunselected"})}_self.fire("rowselectchanged",{data:data,row:row,selected:selected})}});return TmSimpleGrid},{requires:["xtemplate","./store","mui/pagination","./uicommon","sizzle","grid.css"]});