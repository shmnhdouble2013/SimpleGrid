/* build 2013-10-25 17:36:38 */
KISSY.add(function(S){var DOM=S.DOM,Event=S.Event,win=window,UA=S.UA;function Store(config){var _self=this;config=config||{};config=S.merge({root:"rows",totalProperty:"results",sortInfo:{field:"",direction:"ASC",dataType:"string"},proxy:{url:null,method:"post",dataType:"json"},params:{},localSort:true,dataField:"id",pageInfo:{currentPage:1,limit:10,totalPage:3},localPagination:false,isPagination:true},config);S.mix(_self,config);S.mix(_self,{resultRows:[],newRecords:[],modifiedRecords:[],deletedRecords:[],disableRecords:[],rowCount:0,totalCount:0,totalData:[]});_self.events=["acceptchanges","load","beforeload","beforeProcessLoad","addrecords","exception","removerecords","updaterecord","localsort","disableRecords","cancelDisableRecords","totalPageChange","currentPageChanged"];_self._init()}S.augment(Store,S.EventTarget);S.augment(Store,{acceptChanges:function(){var _self=this;_self._clearChanges();_self.fire("acceptchanges")},add:function(data,noRepeat,match){var _self=this,newData=[];match=S.isFunction(match)?match:_self._getDefaultMatch();if(!S.isArray(data)){data=[data]}S.each(data,function(element){if(!noRepeat||!_self.contains(element,match)){_self._addRecord(element);newData.push(element);_self.newRecords.push(element);_self._removeFrom(element,_self.deletedRecords);_self._removeFrom(element,_self.modifiedRecords);_self._removeFrom(element,_self.disableRecords)}});_self.fire("addrecords",{data:newData})},clear:function(){var _self=this;_self.setResult([])},compare:function(obj1,obj2,field,direction,dataType){var _self=this,dir=1;field=field||_self.sortInfo.field;direction=direction||_self.sortInfo.direction;dataType=dataType||_self.sortInfo.dataType;if(!field||!direction){return 1}dir=direction==="ASC"?1:-1;return this.compareFunction(obj1[field],obj2[field],dataType)*dir},contains:function(record,match){return this.findIndexBy(record,match)!==-1},findIndexBy:function(target,func){var _self=this,position=-1,records=this.resultRows;func=S.isFunction(func)?func:_self._getDefaultMatch();if(S.isUndefined(target)||S.isNull(target)){return-1}S.each(records,function(record,index){if(func.call(_self,target,record)){position=index;return false}});return position},find:function(field,value,func){var result=null,records=this.resultRows;S.each(records,function(record,index){if(func&&func.call(this,record[field],value)||record[field]===value){result=record;return false}});return result},findByIndex:function(index){return this.resultRows[index]},findAll:function(field,value,func){var result=[],records=this.resultRows;S.each(records,function(record,index){if(func&&func.call(this,record[field],value)||record[field]===value){result.push(record)}});return result},findNextRecord:function(record){var _self=this,index=_self.findIndexBy(record);if(index>=0){return _self.findByIndex(index+1)}return undefined},load:function(params){this._loadData(params)},getResult:function(){return this.resultRows},getCount:function(){return this.resultRows.length},getNewRecords:function(){return this.newRecords},getModifiedRecords:function(){return this.modifiedRecords},getDeletedRecords:function(){return this.deletedRecords},getDisableRecords:function(){return this.disableRecords},getTotalCount:function(){return this.totalCount},remove:function(data,match){var _self=this,delData=[];match=S.isFunction(match)?match:_self._getDefaultMatch();if(!S.isArray(data)){data=[data]}S.each(data,function(element){var index=_self.findIndexBy(element,match),record=_self._removeAt(index);if(!S.inArray(record,_self.newRecords)&&!S.inArray(record,_self.deletedRecords)){_self.deletedRecords.push(record)}_self._removeFrom(record,_self.newRecords);_self._removeFrom(record,_self.modifiedRecords);delData.push(record)});_self.fire("removerecords",{data:delData})},setResult:function(data){var _self=this,data=data||[];_self.resultRows=data;_self.rowCount=data.length;_self.totalCount=data.length;if(_self.isPagination){data=_self._localPagination()}_self.fire("load",{loadparams:_self.oldParams,data:data})},setValue:function(obj,field,value,isMatch){var record=obj,_self=this,match=null,index=null;if(isMatch){match=_self._getDefaultMatch();index=_self.findIndexBy(obj,match);if(index>=0){record=this.resultRows[index]}}record[field]=value;if(!S.inArray(record,_self.newRecords)&&!S.inArray(record,_self.modifiedRecords)){_self.modifiedRecords.push(record)}_self.fire("updaterecord",{record:record,field:field,value:value})},sort:function(field,direction,dataType){var _self=this;_self.sortInfo.field=field||_self.sortInfo.field;_self.sortInfo.direction=direction||_self.sortInfo.direction;_self.sortInfo.dataType=dataType||_self.sortInfo.dataType;if(!_self.localSort){this.load()}else{_self._sortData(field,direction,dataType);_self.fire("localsort",_self.sortInfo)}},update:function(obj,isMatch){var record=obj,_self=this,match=null,index=null;if(isMatch){match=_self._getDefaultMatch();index=_self.findIndexBy(obj,match);if(index>=0){record=this.resultRows[index]}}record=S.mix(record,obj);if(!S.inArray(record,_self.newRecords)&&!S.inArray(record,_self.modifiedRecords)){_self.modifiedRecords.push(record)}_self.fire("updaterecord",{record:record})},destroy:function(){var _self=this;_self.detach();_self=null},_addRecord:function(record,index){var _self=this,records=_self.resultRows;if(S.isUndefined(index)){index=records.length}records[index]=record;_self.fire("recordadded",{record:record,index:index})},_clearChanges:function(){var _self=this;_self.newRecords.splice(0);_self.modifiedRecords.splice(0);_self.deletedRecords.splice(0);_self.disableRecords.splice(0)},setDisableRecords:function(data){var _self=this;data=S.isArray(data)?data:[data];S.each(data,function(obj,index){if(!S.inArray(obj,_self.disableRecords)){_self.disableRecords.push(obj)}});_self.fire("disableRecords",{data:data})},cancelDisableRecords:function(data){var _self=this;data=S.isArray(data)?data:[data];S.each(data,function(obj){var lindex=S.indexOf(obj,_self.disableRecords);if(lindex>-1){_self.disableRecords.splice(lindex,1)}});_self.fire("cancelDisableRecords",{data:data})},_loadData:function(params){var _self=this,loadparams=params||{},data=null;function setResultLocal(resultRows,rowCount,totalCount){_self.resultRows=resultRows;_self.rowCount=rowCount;_self.totalCount=totalCount}_self.fire("beforeload");var loadparamses=S.merge(_self.oldParams,_self.sortInfo,_self.pageInfo,loadparams);_self.oldParams=loadparamses;_self.attrUpdater(loadparams);if(_self.proxy.dataType==="jsonp"){_self.proxy.method="get"}data=_self.proxy.method==="post"?loadparamses:loadparamses?S.param(loadparamses):"";S.ajax({cache:false,url:_self.proxy.url,dataType:_self.proxy.dataType,type:_self.proxy.method,data:data,success:function(data,textStatus,XMLHttpRequest){_self.fire("beforeProcessLoad",{data:data});var resultRows=[],rowCount=0,totalCount=0;if(data.hasError){setResultLocal(resultRows,rowCount,totalCount);_self.fire("exception",{error:data.error});return}if(S.isString(data)){try{data=S.JSON.parse(data)}catch(ex){S.log("json\u6570\u636e\u8f6c\u6362\u51fa\u9519\uff1a"+ex);data=[]}}if(S.isArray(data)){resultRows=data;rowCount=resultRows.length;totalCount=rowCount}else if(S.isObject(data)){resultRows=data[_self.root];if(!resultRows){resultRows=[]}rowCount=resultRows.length;totalCount=rowCount||parseInt(data[_self.totalProperty],10)}setResultLocal(resultRows,rowCount,totalCount);if(_self.localSort){_self._sortData()}_self.setTotalPage(_self.calculatePageTotal());_self.fire("load",{loadparams:loadparamses,data:data});_self._clearChanges()},error:function(XMLHttpRequest,textStatus,errorThrown){setResultLocal([],0,0);_self.fire("exception",{error:textStatus,responseText:errorThrown.responseText})}})},attrUpdater:function(loadparams){var _self=this;_self.proxy=S.mix(_self.proxy,loadparams,true,["dataType","method"]);_self.sortInfo=S.mix(_self.sortInfo,loadparams,true,["field","direction"]);_self.pageInfo=S.mix(_self.pageInfo,loadparams,true,["currentPage","limit","totalPage"])},_removeAt:function(index,array){if(index<0){return}var records=array||this.resultRows,record=records[index];records.splice(index,1);return record},_removeFrom:function(record,array){var _self=this,index=S.indexOf(record,array);if(index>=0){_self._removeAt(index,array)}},_sortData:function(field,direction,dataType){var _self=this;field=field||_self.sortInfo.field;direction=direction||_self.sortInfo.direction;dataType=dataType||_self.sortInfo.dataType;if(!field||!direction){return}_self.resultRows.sort(function(obj1,obj2){return _self.compare(obj1,obj2,field,direction,dataType)})},_getDefaultMatch:function(){return this.matchFunction},calculatePageTotal:function(totalRows,length){var _self=this,recordNos=_self.getTotalCount(),limit=_self.getPageSize();if(!totalRows&&!length){return Math.ceil(recordNos/limit)}return Math.ceil(totalRows/length)},_localPagination:function(){var _self=this,limit=_self.getPageSize(),nubs=_self.calculatePageTotal();var start=0,end=0,curPageData=[],totalLength=_self.getTotalPage(),page=_self.getCurrentPage();if(!_self.totalData.length){_self.totalData=_self.getResult()}_self.setTotalPage(nubs);if(page<1){page=1}if(page>totalLength){page=totalLength}start=page===1?0:page*limit-limit;end=page===1?limit:page===totalLength?undefined:page*limit;if(end===undefined){curPageData=_self.totalData.slice(start)}else{curPageData=_self.totalData.slice(start,end)}_self.setCurrentPage(page);_self.resultRows=curPageData;return curPageData},getCurrentPage:function(){var _self=this;return _self.pageInfo.currentPage},setCurrentPage:function(curPage){var _self=this;if(S.isNumber(curPage)&&curPage>=0){_self.pageInfo.currentPage=curPage;return curPage}else{console.log("Invalid pagination value!")}},getPageSize:function(){var _self=this;return _self.pageInfo.limit},getTotalPage:function(){var _self=this;return _self.pageInfo.totalPage},setTotalPage:function(totalPage){var _self=this,beforTotalPage=_self.getTotalPage();if(totalPage!==beforTotalPage&&totalPage>=0){_self.pageInfo.totalPage=totalPage;_self.fire("totalPageChange")}return _self.pageInfo},matchFunction:function(obj1,obj2){var _self=this,dataField=_self.dataField,obj1Field=obj1[dataField],obj2Field=obj2[dataField];if(obj1Field!==undefined&&obj2Field!==undefined){return obj1Field===obj2Field}else{return obj1===obj2}},compareFunction:function(obj1,obj2,dataType){var _self=this,obj1=_self.dataMachining(obj1,dataType)||"",obj2=_self.dataMachining(obj2,dataType)||"";if(S.isString(obj1)){return obj1.localeCompare(obj2)}else if(S.isNumber(obj1)){return obj1-obj2}},dataMachining:function(value,valueType){if(!value){return}switch(valueType){case"float":return parseFloat(value);break;case"int":return parseInt(value,10);break;case"date":return new Date(Date.parse(value.replace(/\-/g,"/")));break;default:return value.toString()}},_init:function(){var _self=this;_self.oldParams=_self.params||{};if(_self.url){_self.proxy.url=_self.url}if(_self.method){_self.proxy.method=_self.method}if(_self.dataType){_self.proxy.dataType=_self.dataType}if(S.isNumber(_self.totalPage)){_self.pageInfo.totalPage=_self.totalPage}if(S.isNumber(_self.limit)){_self.pageInfo.limit=_self.limit}if(S.isNumber(_self.currentPage)){_self.pageInfo.currentPage=_self.currentPage}_self.resultRows=[]}});return Store},{requires:[]});